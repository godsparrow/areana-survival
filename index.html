<!DOCTYPE html>
<html>
<head>
<title>Terraria Style Arena</title>
<style>
body { margin:0; background:#1d1f21; overflow:hidden; }
canvas { display:block; margin:auto; image-rendering:pixelated; }
</style>
</head>
<body>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = 900;
canvas.height = 600;

let keys = {};
document.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
document.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

let player = {
    x: canvas.width/2,
    y: canvas.height/2,
    speed: 4,
    fireRate: 20,
    cooldown: 0,
    bulletSpeed: 8,
    damage: 1,
    health: 100,
    maxHealth: 100,
    angle: 0,
    level: 1,
    xp: 0,
    xpNeeded: 20
};

let bullets = [];
let enemies = [];
let gamePaused = false;
let levelChoices = [];

function spawnEnemy() {
    let x = Math.random() * canvas.width;
    let y = -40;

    enemies.push({
        x,y,
        size: 32,
        speed: 1.2 + player.level*0.1,
        health: 4 + player.level,
        xpValue: 5
    });
}
setInterval(spawnEnemy, 1400);

function shoot(target){
    let angle = Math.atan2(target.y-player.y,target.x-player.x);
    bullets.push({
        x: player.x,
        y: player.y,
        dx: Math.cos(angle)*player.bulletSpeed,
        dy: Math.sin(angle)*player.bulletSpeed,
        size:6,
        damage: player.damage
    });
    player.angle = angle;
}

function levelUp(){
    gamePaused = true;
    player.level++;
    player.xp = 0;
    player.xpNeeded += 20;

    levelChoices = [
        "Damage Up",
        "Fire Rate Up",
        "Bullet Speed Up",
        "Speed Up",
        "Max Health Up"
    ];
}

function applyUpgrade(choice){
    if(choice==="Damage Up") player.damage++;
    if(choice==="Fire Rate Up") player.fireRate=Math.max(5,player.fireRate-3);
    if(choice==="Bullet Speed Up") player.bulletSpeed+=2;
    if(choice==="Speed Up") player.speed+=0.5;
    if(choice==="Max Health Up"){
        player.maxHealth+=20;
        player.health+=20;
    }
    gamePaused=false;
}

canvas.addEventListener("click",e=>{
    if(!gamePaused) return;
    let rect=canvas.getBoundingClientRect();
    let mx=e.clientX-rect.left;
    let my=e.clientY-rect.top;

    levelChoices.forEach((choice,i)=>{
        let y=200+i*60;
        if(mx>300&&mx<600&&my>y-20&&my<y+20){
            applyUpgrade(choice);
        }
    });
});

function update(){
    if(gamePaused) return;

    if(keys["w"]) player.y-=player.speed;
    if(keys["s"]) player.y+=player.speed;
    if(keys["a"]) player.x-=player.speed;
    if(keys["d"]) player.x+=player.speed;

    player.x=Math.max(0,Math.min(canvas.width,player.x));
    player.y=Math.max(0,Math.min(canvas.height,player.y));

    enemies.forEach(e=>{
        let dx=player.x-e.x;
        let dy=player.y-e.y;
        let dist=Math.sqrt(dx*dx+dy*dy);
        e.x+=dx/dist*e.speed;
        e.y+=dy/dist*e.speed;

        if(dist<20) player.health-=0.2;
    });

    let closest=null;
    let closestDist=Infinity;
    enemies.forEach(e=>{
        let dx=e.x-player.x;
        let dy=e.y-player.y;
        let dist=Math.sqrt(dx*dx+dy*dy);
        if(dist<closestDist){
            closestDist=dist;
            closest=e;
        }
    });

    if(closest&&player.cooldown<=0){
        shoot(closest);
        player.cooldown=player.fireRate;
    }
    if(player.cooldown>0) player.cooldown--;

    bullets.forEach((b,bi)=>{
        b.x+=b.dx;
        b.y+=b.dy;
        if(b.x<0||b.x>canvas.width||b.y<0||b.y>canvas.height){
            bullets.splice(bi,1);
        }
        enemies.forEach((e,ei)=>{
            let dx=e.x-b.x;
            let dy=e.y-b.y;
            let dist=Math.sqrt(dx*dx+dy*dy);
            if(dist<16){
                e.health-=b.damage;
                bullets.splice(bi,1);
                if(e.health<=0){
                    player.xp+=e.xpValue;
                    enemies.splice(ei,1);
                    if(player.xp>=player.xpNeeded) levelUp();
                }
            }
        });
    });

    if(player.health<=0){
        alert("Game Over");
        location.reload();
    }
}

function drawBackground(){
    // dirt
    ctx.fillStyle="#5c4033";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // grass top strip
    ctx.fillStyle="#3cb043";
    ctx.fillRect(0,0,canvas.width,40);
}

function drawPlayer(){
    // body
    ctx.fillStyle="#4a90e2";
    ctx.fillRect(player.x-10,player.y-16,20,24);

    // head
    ctx.fillStyle="#f1c27d";
    ctx.fillRect(player.x-8,player.y-28,16,12);

    // eyes
    ctx.fillStyle="black";
    ctx.fillRect(player.x-4,player.y-24,2,2);
    ctx.fillRect(player.x+2,player.y-24,2,2);

    // gun
    ctx.save();
    ctx.translate(player.x,player.y-10);
    ctx.rotate(player.angle);
    ctx.fillStyle="#c9c9c9";
    ctx.fillRect(8,-3,18,6);
    ctx.restore();
}

function drawEnemies(){
    enemies.forEach(e=>{
        // slime body
        ctx.fillStyle="#5aff5a";
        ctx.fillRect(e.x-16,e.y-12,32,20);

        // slime top
        ctx.fillStyle="#3bd13b";
        ctx.fillRect(e.x-12,e.y-20,24,10);

        // eyes
        ctx.fillStyle="black";
        ctx.fillRect(e.x-6,e.y-10,4,4);
        ctx.fillRect(e.x+2,e.y-10,4,4);
    });
}

function drawBullets(){
    ctx.fillStyle="#00ffff";
    bullets.forEach(b=>{
        ctx.fillRect(b.x-3,b.y-3,6,6);
    });
}

function drawUI(){
    ctx.fillStyle="white";
    ctx.font="18px monospace";
    ctx.fillText("HP: "+Math.floor(player.health)+"/"+player.maxHealth,20,30);
    ctx.fillText("Level: "+player.level,20,55);

    ctx.fillStyle="#444";
    ctx.fillRect(20,70,200,15);
    ctx.fillStyle="#00ff00";
    ctx.fillRect(20,70,(player.xp/player.xpNeeded)*200,15);
}

function drawLevelMenu(){
    ctx.fillStyle="rgba(0,0,0,0.8)";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.fillStyle="white";
    ctx.font="30px monospace";
    ctx.fillText("LEVEL UP!",340,120);

    ctx.font="20px monospace";
    levelChoices.forEach((choice,i)=>{
        let y=200+i*60;
        ctx.fillStyle="#3cb043";
        ctx.fillRect(300,y-20,300,40);
        ctx.fillStyle="black";
        ctx.fillText(choice,350,y+5);
    });
}

function draw(){
    drawBackground();
    drawPlayer();
    drawEnemies();
    drawBullets();
    drawUI();
    if(gamePaused) drawLevelMenu();
}

function loop(){
    update();
    draw();
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
