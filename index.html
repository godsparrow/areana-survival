// ==========================
// TOP DOWN RPG ENGINE V1
// ==========================

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

canvas.width = 1000;
canvas.height = 600;

// ==========================
// WORLD + CAMERA
// ==========================

const WORLD_WIDTH = 5000;
const WORLD_HEIGHT = 5000;
const TILE_SIZE = 64;

let camera = {
    x: 0,
    y: 0
};

// ==========================
// GAME STATE
// ==========================

let paused = false;
let keys = {};
let enemies = [];
let projectiles = [];
let drops = [];

// ==========================
// PLAYER
// ==========================

let player = {
    x: 2500,
    y: 2500,
    size: 64,
    speed: 4,
    hp: 100,
    maxHp: 100,
    damage: 15,
    spell: "arcane",
    frame: 0,
    frameTick: 0,
    inventory: [],
    equipment: {
        helmet: null,
        chest: null,
        staff: null,
        ring: null
    }
};

// ==========================
// INPUT
// ==========================

document.addEventListener("keydown", e => {
    keys[e.key] = true;
    if (e.key === "p") paused = !paused;
});
document.addEventListener("keyup", e => keys[e.key] = false);

// ==========================
// TILE MAP
// ==========================

function drawWorld() {
    for (let x = 0; x < WORLD_WIDTH; x += TILE_SIZE) {
        for (let y = 0; y < WORLD_HEIGHT; y += TILE_SIZE) {

            let screenX = x - camera.x;
            let screenY = y - camera.y;

            if (screenX > -TILE_SIZE && screenX < canvas.width &&
                screenY > -TILE_SIZE && screenY < canvas.height) {

                // Terraria style grass shading
                ctx.fillStyle = "#3c9c3c";
                ctx.fillRect(screenX, screenY, TILE_SIZE, TILE_SIZE);

                ctx.fillStyle = "#2f7f2f";
                ctx.fillRect(screenX, screenY + 48, TILE_SIZE, 16);
            }
        }
    }
}

// ==========================
// PLAYER ANIMATION
// ==========================

function updatePlayer() {
    let moving = false;

    if (keys["w"]) { player.y -= player.speed; moving = true; }
    if (keys["s"]) { player.y += player.speed; moving = true; }
    if (keys["a"]) { player.x -= player.speed; moving = true; }
    if (keys["d"]) { player.x += player.speed; moving = true; }

    if (moving) {
        player.frameTick++;
        if (player.frameTick > 10) {
            player.frame = (player.frame + 1) % 4;
            player.frameTick = 0;
        }
    }

    camera.x = player.x - canvas.width / 2;
    camera.y = player.y - canvas.height / 2;
}

function drawPlayer() {

    let px = player.x - camera.x - 32;
    let py = player.y - camera.y - 32;

    // Base body (highly shaded pixel look)
    ctx.fillStyle = "#4fa3ff";
    ctx.fillRect(px, py, 64, 64);

    ctx.fillStyle = "#2e6fa8";
    ctx.fillRect(px, py + 40, 64, 24);

    // Helmet overlay
    if (player.equipment.helmet) {
        ctx.fillStyle = player.equipment.helmet.color;
        ctx.fillRect(px + 10, py + 5, 44, 20);
    }

    // Chest overlay
    if (player.equipment.chest) {
        ctx.fillStyle = player.equipment.chest.color;
        ctx.fillRect(px + 8, py + 25, 48, 30);
    }

    // Staff overlay
    if (player.equipment.staff) {
        ctx.fillStyle = "#8b5a2b";
        ctx.fillRect(px + 50, py + 20, 14, 6);
    }

    // Elite glow ring if ring equipped
    if (player.equipment.ring) {
        ctx.strokeStyle = player.equipment.ring.color;
        ctx.beginPath();
        ctx.arc(px + 32, py + 32, 40, 0, Math.PI * 2);
        ctx.stroke();
    }
}

// ==========================
// ENEMIES
// ==========================

function spawnEnemy() {

    let elite = Math.random() < 0.15;

    enemies.push({
        x: Math.random() * WORLD_WIDTH,
        y: Math.random() * WORLD_HEIGHT,
        size: 64,
        hp: elite ? 200 : 100,
        speed: elite ? 2.5 : 1.5,
        damage: elite ? 20 : 10,
        elite: elite
    });
}

function updateEnemies() {
    enemies.forEach(enemy => {

        let dx = player.x - enemy.x;
        let dy = player.y - enemy.y;
        let dist = Math.sqrt(dx*dx + dy*dy);

        enemy.x += dx/dist * enemy.speed;
        enemy.y += dy/dist * enemy.speed;
    });
}

function drawEnemies() {
    enemies.forEach(enemy => {

        let ex = enemy.x - camera.x - 32;
        let ey = enemy.y - camera.y - 32;

        ctx.fillStyle = enemy.elite ? "#ff4444" : "#6a1b9a";
        ctx.fillRect(ex, ey, 64, 64);

        if (enemy.elite) {
            ctx.strokeStyle = "yellow";
            ctx.strokeRect(ex-4, ey-4, 72, 72);
        }
    });
}

// ==========================
// SPELLS
// ==========================

function castSpell() {
    let type = player.spell;

    projectiles.push({
        x: player.x,
        y: player.y,
        type: type,
        life: 100
    });
}

function updateProjectiles() {
    projectiles.forEach((p, i) => {
        p.life--;
        if (p.life <= 0) projectiles.splice(i,1);
    });
}

function drawProjectiles() {
    projectiles.forEach(p => {
        let px = p.x - camera.x;
        let py = p.y - camera.y;

        if (p.type === "arcane") ctx.fillStyle = "cyan";
        if (p.type === "fire") ctx.fillStyle = "orange";
        if (p.type === "lightning") ctx.fillStyle = "yellow";

        ctx.beginPath();
        ctx.arc(px, py, 10, 0, Math.PI*2);
        ctx.fill();
    });
}

// ==========================
// DROPS + EQUIPMENT
// ==========================

function dropLoot(x, y) {

    if (Math.random() < 0.5) {

        let types = ["helmet", "chest", "ring"];
        let type = types[Math.floor(Math.random()*types.length)];

        drops.push({
            x: x,
            y: y,
            type: type,
            color: ["#aaa","#00ffcc","#ff00ff"][Math.floor(Math.random()*3)]
        });
    }
}

function drawDrops() {
    drops.forEach(drop => {
        ctx.fillStyle = drop.color;
        ctx.fillRect(drop.x - camera.x - 10, drop.y - camera.y - 10, 20, 20);
    });
}

// ==========================
// INVENTORY PANEL
// ==========================

function drawInventory() {

    ctx.fillStyle = "rgba(0,0,0,0.85)";
    ctx.fillRect(200,100,600,400);

    ctx.fillStyle = "white";
    ctx.fillText("EQUIPMENT", 450, 130);

    ctx.fillText("Helmet: " + (player.equipment.helmet ? "Equipped" : "Empty"), 300, 200);
    ctx.fillText("Chest: " + (player.equipment.chest ? "Equipped" : "Empty"), 300, 230);
    ctx.fillText("Staff: " + (player.equipment.staff ? "Equipped" : "Empty"), 300, 260);
    ctx.fillText("Ring: " + (player.equipment.ring ? "Equipped" : "Empty"), 300, 290);
}

// ==========================
// UPDATE LOOP
// ==========================

function update() {
    if (paused) return;

    updatePlayer();
    updateEnemies();
    updateProjectiles();
}

// ==========================
// DRAW LOOP
// ==========================

function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    drawWorld();
    drawEnemies();
    drawDrops();
    drawProjectiles();
    drawPlayer();

    if (paused) drawInventory();
}

function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
}

// Spawn starting enemies
for (let i=0;i<10;i++) spawnEnemy();

gameLoop();
