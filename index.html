<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Arcane Arena</title>
<style>
body { margin:0; overflow:hidden; background:#1b1b1b; }
canvas { display:block; image-rendering: pixelated; }

#ui {
 position:absolute;
 top:10px;
 left:50%;
 transform:translateX(-50%);
 width:420px;
}

.bar { height:18px; background:#222; margin-bottom:6px; border:2px solid black; }
#hpFill { height:100%; background:#00cc44; width:100%; }
#expFill { height:100%; background:#0066ff; width:0%; }

#statMenu {
 position:absolute;
 top:50%;
 left:50%;
 transform:translate(-50%,-50%);
 background:#20283a;
 padding:20px;
 border:4px solid #4a6bd6;
 display:none;
 color:white;
 width:320px;
}

button {
 width:100%;
 margin:5px 0;
 padding:8px;
 background:#304a9f;
 border:none;
 color:white;
 cursor:pointer;
}
button:hover { background:#4664d8; }
</style>
</head>
<body>
<canvas id="game"></canvas>

<div id="ui">
 <div class="bar"><div id="hpFill"></div></div>
 <div class="bar"><div id="expFill"></div></div>
</div>

<div id="statMenu">
 <h3>Stats (Points: <span id="points">0</span>)</h3>
 <button onclick="upgrade('damage')">Damage (<span id="dmgStat"></span>)</button>
 <button onclick="upgrade('speed')">Speed (<span id="spdStat"></span>)</button>
 <button onclick="upgrade('rate')">Fire Rate (<span id="rateStat"></span>)</button>
 <button onclick="toggleStats()">Close</button>
</div>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
canvas.width=window.innerWidth;
canvas.height=window.innerHeight;

let paused=false;
let keys={};

let player={
 x:0,y:0,
 hp:100,maxHp:100,
 exp:0,
 level:1,
 points:0,
 damage:12,
 speed:2.5,
 fireRate:600,
 lastShot:0,
 anim:0
};

let enemies=[];
let bullets=[];
let particles=[];
let expToLevel=50;

document.addEventListener("keydown",e=>{
 if(e.key==="Tab"){
  e.preventDefault();
  toggleStats();
 }
 keys[e.key.toLowerCase()]=true;
});
document.addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);

function toggleStats(){
 paused=!paused;
 document.getElementById("statMenu").style.display=paused?"block":"none";
 updateStatsUI();
}

function upgrade(stat){
 if(player.points<=0) return;

 if(stat==="damage") player.damage+=4;
 if(stat==="speed") player.speed+=0.4;

 if(stat==="rate"){
  if(player.fireRate>300){
   player.fireRate-=50;
  } else {
   player.fireRate=Math.max(80,player.fireRate/2);
  }
 }

 player.points--;
 updateStatsUI();
}

function updateStatsUI(){
 document.getElementById("points").innerText=player.points;
 document.getElementById("dmgStat").innerText=player.damage;
 document.getElementById("spdStat").innerText=player.speed.toFixed(1);
 document.getElementById("rateStat").innerText=Math.floor(player.fireRate);
}

function spawnEnemy(){
 const types=["slime","goblin","demon","ghost"];
 const type=types[Math.floor(Math.random()*types.length)];

 enemies.push({
  x:(Math.random()-0.5)*1200,
  y:(Math.random()-0.5)*1200,
  type:type,
  hp: type==="demon"?100:type==="goblin"?70:type==="ghost"?60:50,
  maxHp: type==="demon"?100:type==="goblin"?70:type==="ghost"?60:50,
  showHP:0
 });
}

for(let i=0;i<8;i++) spawnEnemy();

function loop(){
 requestAnimationFrame(loop);
 if(paused) return;
 update();
 draw();
}
loop();

function update(){
 player.anim+=0.15;

 if(keys["w"]) player.y-=player.speed;
 if(keys["s"]) player.y+=player.speed;
 if(keys["a"]) player.x-=player.speed;
 if(keys["d"]) player.x+=player.speed;

 autoAim();

 enemies.forEach(e=>{
  let dx=player.x-e.x;
  let dy=player.y-e.y;
  let dist=Math.hypot(dx,dy);
  e.x+=dx/dist*1.2;
  e.y+=dy/dist*1.2;

  if(e.showHP>0) e.showHP--;
 });

 bullets.forEach(b=>{
  b.x+=b.dx;
  b.y+=b.dy;

  enemies.forEach(e=>{
   if(Math.hypot(b.x-e.x,b.y-e.y)<20){
    e.hp-=player.damage;
    e.showHP=60;
    b.dead=true;

    if(e.hp<=0){
     player.exp+=25;
     enemies.splice(enemies.indexOf(e),1);
     spawnEnemy();
    }
   }
  });

  particles.push({x:b.x,y:b.y,life:20});
 });

 bullets=bullets.filter(b=>!b.dead);

 particles.forEach(p=>p.life--);
 particles=particles.filter(p=>p.life>0);

 // ===== FIXED LEVEL SYSTEM =====
 while(player.exp >= expToLevel){
  player.exp -= expToLevel;
  player.level++;
  player.points += 3;
  expToLevel = Math.floor(expToLevel * 1.3);
 }

 document.getElementById("hpFill").style.width =
  Math.max(0,(player.hp/player.maxHp*100))+"%";

 document.getElementById("expFill").style.width =
  Math.min(100,(player.exp/expToLevel*100))+"%";
}

function autoAim(){
 if(Date.now()-player.lastShot<player.fireRate) return;
 if(enemies.length===0) return;

 const closest=enemies.reduce((a,b)=>
  Math.hypot(player.x-a.x,player.y-a.y)<
  Math.hypot(player.x-b.x,player.y-b.y)?a:b
 );

 const dx=closest.x-player.x;
 const dy=closest.y-player.y;
 const dist=Math.hypot(dx,dy);

 bullets.push({
  x:player.x,
  y:player.y,
  dx:dx/dist*6,
  dy:dy/dist*6
 });

 player.lastShot=Date.now();
}

function draw(){
 ctx.clearRect(0,0,canvas.width,canvas.height);
 ctx.save();
 ctx.translate(canvas.width/2-player.x,canvas.height/2-player.y);

 drawTiles();

 particles.forEach(p=>{
  ctx.fillStyle="rgba(100,180,255,"+(p.life/20)+")";
  ctx.fillRect(p.x,p.y,4,4);
 });

 bullets.forEach(b=>{
  ctx.fillStyle="#66ccff";
  ctx.beginPath();
  ctx.arc(b.x,b.y,6,0,Math.PI*2);
  ctx.fill();
 });

 enemies.forEach(drawEnemy);
 drawPlayer();

 ctx.restore();
}

function drawPlayer(){
 const bob=Math.sin(player.anim)*2;

 ctx.fillStyle="#000"; 
 ctx.fillRect(player.x-11,player.y-21,22,34);

 ctx.fillStyle="#3b5cff";
 ctx.fillRect(player.x-10,player.y-8,20,18);

 ctx.fillStyle="#2a3fb5";
 ctx.fillRect(player.x-10,player.y-8,4,18);

 ctx.fillStyle="#f1c27d";
 ctx.fillRect(player.x-6,player.y-20,12,12);

 ctx.fillStyle="#5a3a1a";
 ctx.fillRect(player.x-6,player.y-20,12,4);

 ctx.fillStyle="#7a4a2a";
 ctx.fillRect(player.x+10,player.y-6,4,24);

 ctx.fillStyle="#00e0ff";
 ctx.fillRect(player.x+8,player.y-12,8,6);
}

// ===== IMPROVED ENEMIES =====
function drawEnemy(e){
 let y=e.y+Math.sin(Date.now()*0.004)*2;

 ctx.fillStyle="#000";

 if(e.type==="slime"){
  ctx.fillRect(e.x-16,y-12,32,24);
  ctx.fillStyle="#3ddc6f";
  ctx.fillRect(e.x-14,y-10,28,20);
  ctx.fillStyle="#7effa6";
  ctx.fillRect(e.x-6,y-6,6,6);
 }

 if(e.type==="goblin"){
  ctx.fillRect(e.x-14,y-16,28,32);
  ctx.fillStyle="#2faa2f";
  ctx.fillRect(e.x-12,y-14,24,28);
  ctx.fillStyle="#145a14";
  ctx.fillRect(e.x-12,y-14,5,28);
 }

 if(e.type==="demon"){
  ctx.fillRect(e.x-18,y-18,36,36);
  ctx.fillStyle="#aa2222";
  ctx.fillRect(e.x-16,y-16,32,32);
  ctx.fillStyle="#ff4444";
  ctx.fillRect(e.x-6,y-6,4,4);
 }

 if(e.type==="ghost"){
  ctx.fillRect(e.x-14,y-18,28,36);
  ctx.fillStyle="#bbbbff";
  ctx.fillRect(e.x-12,y-16,24,32);
  ctx.fillStyle="#ff0000";
  ctx.fillRect(e.x-4,y-6,4,4);
 }

 if(e.showHP>0){
  ctx.fillStyle="red";
  ctx.fillRect(e.x-15,y-24,30*(e.hp/e.maxHp),4);
 }
}

function drawTiles(){
 for(let x=-2000;x<2000;x+=64){
  for(let y=-2000;y<2000;y+=64){
   ctx.fillStyle=((x+y)/64)%2?"#232323":"#262626";
   ctx.fillRect(x,y,64,64);
  }
 }
}
</script>
</body>
</html>
