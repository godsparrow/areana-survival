<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

canvas.width = 800;
canvas.height = 500;

let keys = {};
let mouse = { x: 0, y: 0 };

document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

canvas.addEventListener("mousemove", e => {
    const rect = canvas.getBoundingClientRect();
    mouse.x = e.clientX - rect.left;
    mouse.y = e.clientY - rect.top;
});

let player = {
    x: 400,
    y: 250,
    size: 20,
    speed: 4,
    attackCooldown: 0,
    health: 5
};

let enemies = [];
let projectiles = [];
let wave = 1;

function spawnWave() {
    for (let i = 0; i < wave + 2; i++) {
        enemies.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            size: 18,
            speed: 1 + wave * 0.2
        });
    }
}

spawnWave();

canvas.addEventListener("click", () => {
    if (player.attackCooldown <= 0) {
        let dx = mouse.x - player.x;
        let dy = mouse.y - player.y;
        let dist = Math.sqrt(dx*dx + dy*dy);

        projectiles.push({
            x: player.x,
            y: player.y,
            size: 6,
            vx: dx / dist * 6,
            vy: dy / dist * 6
        });

        player.attackCooldown = 15;
    }
});

function update() {

    // Movement
    if (keys["w"] || keys["ArrowUp"]) player.y -= player.speed;
    if (keys["s"] || keys["ArrowDown"]) player.y += player.speed;
    if (keys["a"] || keys["ArrowLeft"]) player.x -= player.speed;
    if (keys["d"] || keys["ArrowRight"]) player.x += player.speed;

    player.x = Math.max(player.size, Math.min(canvas.width - player.size, player.x));
    player.y = Math.max(player.size, Math.min(canvas.height - player.size, player.y));

    if (player.attackCooldown > 0) player.attackCooldown--;

    // Move projectiles
    projectiles.forEach((p, i) => {
        p.x += p.vx;
        p.y += p.vy;

        if (p.x < 0 || p.x > canvas.width || p.y < 0 || p.y > canvas.height) {
            projectiles.splice(i, 1);
        }
    });

    // Move enemies
    enemies.forEach(e => {
        let dx = player.x - e.x;
        let dy = player.y - e.y;
        let dist = Math.sqrt(dx*dx + dy*dy);
        e.x += dx / dist * e.speed;
        e.y += dy / dist * e.speed;

        if (dist < e.size + player.size) {
            player.health--;
            e.x = Math.random() * canvas.width;
            e.y = Math.random() * canvas.height;
        }
    });

    // Projectile collision
    projectiles.forEach((p, pi) => {
        enemies.forEach((e, ei) => {
            let dx = p.x - e.x;
            let dy = p.y - e.y;
            if (Math.sqrt(dx*dx + dy*dy) < p.size + e.size) {
                enemies.splice(ei, 1);
                projectiles.splice(pi, 1);
            }
        });
    });

    if (enemies.length === 0) {
        wave++;
        spawnWave();
    }

    if (player.health <= 0) {
        alert("Game Over! Wave reached: " + wave);
        document.location.reload();
    }
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Player
    ctx.fillStyle = "#00f7ff";
    ctx.beginPath();
    ctx.arc(player.x, player.y, player.size, 0, Math.PI*2);
    ctx.fill();

    // Enemies
    ctx.fillStyle = "#ff0055";
    enemies.forEach(e => {
        ctx.beginPath();
        ctx.arc(e.x, e.y, e.size, 0, Math.PI*2);
        ctx.fill();
    });

    // Projectiles
    ctx.fillStyle = "#ffffff";
    projectiles.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
        ctx.fill();
    });

    // UI
    ctx.fillStyle = "white";
    ctx.font = "20px Arial";
    ctx.fillText("Health: " + player.health, 10, 25);
    ctx.fillText("Wave: " + wave, 10, 50);
}

function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
}

gameLoop();
</script>
